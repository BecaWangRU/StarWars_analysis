---
title: "Wrangling Final Project"
author: "Ziyan Wang"
date: "April 22, 2019"
output: pdf_document
---

## Idea Introduction

The series movies of Star Wars will be analyzed through different resources with web scrapping, data cleaning, text analysis and visualization skills.Starting from the brief introduction with the Wikipedia page, New York Times API and Character dataset within dplyr are included for detecting more details, such as the review of each movie and the relationship networks among characters.

## Github Link

Analysis in this report is done with R(version 3.7). This PDF is generated by the Rmarkdone file. To check futher details, vist the link below:
https://github.com/BecaWangRU/StarWars_analysis

## Data resources

two websites: 

Wikipedia page of Star Wars:

(url: https://en.wikipedia.org/wiki/List_of_Star_Wars_films_and_television_series)

IMDB page of Star Wars:

(url: https://www.imdb.com/list/ls025989264/)

API of New York Times:

Movie Reviews API & Article Search API
* need to sign up with email to obtain the individual API key.

Characters Dataset "Starwars" within the dplyr package


```{r setup, include=FALSE}
library(rvest)
library(curl)
library(jsonlite)
library(tidyverse)
library(tidytext)
library(igraph)
library(wordcloud)
library(ggthemes)
knitr::opts_chunk$set(echo = TRUE)
```

## Basic Info of the series

Star Wars is an American epic space-opera media franchise created by George Lucas. The franchise began with the eponymous 1977 film and quickly became a worldwide pop-culture phenomenon. Till now there are 11 movies in the whole series, the basic information below is scraped from wikipedia.

```{r, echo = FALSE, warnings = FALSE}
wiki_url <- "https://en.wikipedia.org/wiki/List_of_Star_Wars_films_and_television_series"

wiki <-  wiki_url %>%
  read_html() %>%
  html_nodes("th,td") %>%
  html_text()

publish_date <- wiki[grep(("May|December"),wiki)][1:11]
publish_date <- str_replace_all(publish_date,"^[0-9]{2}|\n$","")
names <- wiki[grep(("May|December"),wiki)-1][1:11]
names <- str_replace_all(names,"^[0-9]{2}|\n$","")
info <- tibble(date = publish_date,name = names)
knitr::kable(info)
```

Usually web scraping from the wikipedia page is easy, but the tables on the Star Wars page is not standard relational table, making it impossible to retrieve the clean table with node "table". So in this part, I first scrape the elements of the tables using node "th,td" with the help of SelectorGadget, and then target the date to extract the information needed. It is convenient since, after observing the information scraped, half of the movies are published in May (movies before 2005), and the other half are published in December. And I am wondering if it is related to the Star Wars day, May 04th, indicating "May the force be with you".

## Summary of the films

After knowing the basic names and publishing dates, it is important to know the storyline of the series. By web scraping on the Wiki page again, finding the summary of each story could tell the main characters and the most frequent used words across the whole stories.

* all the words segmentations in this report have exclude the stopwords, which does not have specific meaning in the context.

* besides, make sure to do the web scraping with both the node "p" (refer to paragraph) and the node "h2" (refer to the heading) so that each movie can be separated using the headings.

```{r,echo = FALSE, warnings = FALSE, fig.align='center'}

summary <- wiki_url %>% read_html() %>%
  html_nodes("h2,p") %>%
  html_text()

summary[grep("Television",summary)]
summary <- summary[1:(grep("Television",summary)[1]-1)]

summary <- tibble(text = summary)
sum_word <- summary %>%
  unnest_tokens(word, text) %>%
  anti_join(stop_words) %>%
  count(word, sort = TRUE) %>%
  arrange(desc(n)) %>%
  with(wordcloud(word, n, max.words = 20,colors = "black"))
sum_word
```

The wordcloud plot gives the top 20 most frequent words in the desciptions. The words that appears a lot in the summaries include force, jedi, awake etc. The result seems quite reasonable, but only two chracters show up in the most frequent words: luke skywalker and han solo. It should be admitted that these two characters are really important through the movies, but bigrams should be taken into consideration since the names mostly come with first name and last name.

```{r, echo = FALSE, warnings = FALSE}

sum_bigram <- summary %>%
  unnest_tokens(bigram, text, token = "ngrams", n = 2)

sum_bigram_separated <- sum_bigram %>%
  separate(bigram, c("word1", "word2"), sep = " ")

sum_bigram_filtered <- sum_bigram_separated %>%
  filter(!word1 %in% stop_words$word) %>%
  filter(!word2 %in% stop_words$word) %>%
  count(word1, word2, sort = TRUE)

knitr::kable(sum_bigram_filtered[1:30,])
```

In the result above, we can see the names of several other characters than Han Solo and Luke Skywalker: Obi Wan, bb 8,  Darth Vader and Lawrence Kasdan, Kylo Ren. However, the summary on the wiki page is not long and specific enough to do further text analysis, so that in the following part resources other than wikipedia will be introduced. 

## Characters

Previous discussion has already shown several important characters of the movie series. In this part, I will show the analysis of characters in Star Wars with the R dataframe "starwars" from the package "dplyr", to figure out the popular characters to see if it conforms to the results above.

```{r, echo=FALSE}
library(dplyr)

for(i in 1:length(starwars)){
  starwars$num_films[i] = length(starwars$films[i][[1]])
}

Chars <- starwars %>%
  arrange(desc(num_films)) %>%
  select(name,species,num_films,films)

knitr::kable(Chars[1:20,])
```

A snippet of my dataframe arranged by the number of films presented has been shown above. We can see the previous names we have are the popular names from the table. But there is only one exception: "Kylo Ren". This character is the villain in the recent movies, chosen name of Ben Solo. This result imply another drawback of the Starars dataset: the data set is little bit out of date, containing only the first seven films of the whole series.

Besides, the character dataframe can also generate the network graph, helping to visualize the relationship between characters. If the characters shows up in same movies, we count one to build up the adjacency matrix and then do the cluster.

* Only the important characters are selected in this graph analysis, which are the top 20 characters that appears in most movies.

```{r,echo = FALSE, warnings = FALSE}

network <- Chars[1:20,] %>% select(name,films) %>%
  unnest() %>%
  as_tibble()

network_matrix <- 
  table(unique(network[,c("name","films")]))

network_adjacency <- network_matrix %*% t(network_matrix)

network_hclust <- hclust(dist(network_adjacency, method = "manhattan"))

plot(network_hclust)
```

In this clustering plot, we can see the result kind of make sense based on the story. R2-D2 is really close to C-3PO. Both of them are roberts. Luke and Leia are twins and are really close in this cluster. Another kind of visualization of the character relationships is the following networks:

```{r,echo = FALSE, warnings = FALSE,fig.align='center'}
network_graph <- graph.adjacency(network_adjacency, 
      weighted = TRUE, mode = "undirected", diag = FALSE)

plot(network_graph, edge.width = E(network_graph)$weight, 
     layout = layout_with_fr)
```


The network seems a little bit messy, so I tried to provide another plot with only top 11 characters, making the core relationships more clear:

```{r,echo = FALSE, warnings = FALSE,fig.align='center'}
network_adjacency2 <- network_adjacency[9:20,9:20]

network_graph2 <- graph.adjacency(network_adjacency2, 
      weighted = TRUE, mode = "undirected", diag = FALSE)

plot(network_graph2, edge.width = E(network_graph2)$weight, 
     layout = layout_with_fr)

```

The first messy network indicates that generating the networks has another draw back: counting one for the mutual appearance in the same movie makes the values in the adjacency matrix small, making the cluster result less precise. In fact, I think about using the reviews of each film to generate another network graph by counting the numbers that characters mutually appear in one review, making the values in adjacency matrix bigger. But it should be really hard. It is not easy to recognize the names of characters from the reviews. If do the words segmentation and compare it to the Starwars dataset, the new character in the last four films cannot be match. Moreover, the names might start with Capital Letters, but after the unnest_tokens function, words are automatically transformed into smaller letter. So this might be a problem that I left here.

## Reviews of the movies

Getting the reviews of each movie helps to know the response of the movie. The New York Times Movie API gives the access to these reviews. By signing in and creating application, the metadata of movie reviews can be obtained, which does not contain the whole reviews, requiring the further web scaping with the urls provided in the metadata. Another quick tip is that New York Times seems change the organization of each article after 2010, indicating that different node and format before and after these time point. 

```{r, echo = FALSE, warnings = FALSE}
source("api_keys.R")

url_nyt_movies <- paste0("https://api.nytimes.com/svc/movies/v2/reviews/search.json?query=star wars&api-key=",yourkey)
json_result_movies <- url_nyt_movies %>% curl() %>%  fromJSON() %>% as_tibble()
title = json_result_movies$results$display_title
web_url = json_result_movies$results$link$url

df <- tibble(title,web_url)
df$article <- "article_body"

for(j in 1:nrow(df)){
  text <- df$web_url[j] %>% read_html() %>%
    html_nodes(".evys1bk0") %>%
    html_text()
  article_i = ""
  for(i in 1:length(text)){
    article_i = paste(article_i,text[i])
  }
  df$article[j] <- article_i
}


###################
# finding out different node for the reviews
for (j in 5:9){
  text <- df$web_url[j] %>% read_html() %>%
    html_nodes(".story-content") %>%
    html_text()
  text = tolower(text)
  article_i = ""
  for(i in 1:length(text)){
    if(grepl("directed",text[i])){
      for(k in 1:i-1){
        article_i = paste(article_i,text[k])
      }
    }
  }
  df$article[j] <- article_i
}



###################
# word segmentation
word_seg <- function(text_seg){
  text <- tibble(text = text_seg)
  tidy <- text %>%
    unnest_tokens(word, text) %>%
    anti_join(stop_words) %>%
    count(word, sort = TRUE)
  return(tidy)
}

bigram_seg <- function(text_seg){
  text <- tibble(text = text_seg)
  bigram <- text %>%
    unnest_tokens(bigram, text, token = "ngrams", n = 2)
  
  bigram_separated <- bigram %>%
    separate(bigram, c("word1", "word2"), sep = " ")
  bigram_filtered <- sum_bigram_separated %>%
    filter(!word1 %in% stop_words$word) %>%
    filter(!word2 %in% stop_words$word) %>%
    count(word1, word2, sort = TRUE)
}

```

After obtaining the nine reviews, we could do text analysis again, finding out the most frequent words or characters in the reviews. Besides, we can use sentiment analysis to try finding out the positive or negative feelings showing towards the movies.

* but the New York Times API just provide 9 reviews of the movie series, meaning that two more movies are not included in the reviews. One is the Episode V The Empire Strikes Back, published in 1980-05-21, another is the Episode III Revenge of the Sith, published in 2005-05-19.

### the whole reviews analysis

First put the reviews together, to detect the most popular words in the text.

```{r,echo = FALSE, warnings = FALSE}
reviews_list <- word_seg(df$article)
reviews_top <- cbind(reviews_list[1:10,],reviews_list[11:20,],reviews_list[21:30,])
colnames(reviews_top) <- c("top10","freq","top20","freq","top30","freq")

knitr::kable(reviews_top)
```

From the result above, it is easy to observe that some of the words come from the same phrases, especially some names are divided into first name and last name. So the following procedure is to split the reviews into bigrams (phrases contain two words). The table below shows the top 30 most popular bigrams in the whole reviews of Star Wars.

```{r,echo = FALSE, warnings = FALSE}
bigram_list <- bigram_seg(df$article)

bigram_top <-  cbind(bigram_list[1:10,],bigram_list[11:20,],bigram_list[21:30,])
colnames(bigram_top) <- c("top 10_word1","top 10_word2","freq","top 20_word1","top 20_word2","freq","top 30_word1","top 30_word2","freq")
knitr::kable(bigram_top)
```

From the two tables above, we can see the bigrams mainly come from the names of charcters, and names of the movies. And some of the bigrams contain numbers that just appear out of expect.

### reviews analysis respectively

There are 9 reviews provided by the New York Times, so we can get 9 separate results from each of them. We can count the word frequency and do some sentiment analysis to help decide whether the review is positive or negative. The feature "direction" is generated by using the number of positive words frequencies minus the number negative words frequencies for each movie. 

```{r,echo = FALSE, warnings = FALSE, message = FALSE}
sentiment1 <- word_seg(df$article[1]) %>%
  inner_join(get_sentiments("bing")) %>%
  mutate(movie = df$title[1]) %>%
  spread(sentiment, n, fill = 0)
  
sentiment2 <- word_seg(df$article[2]) %>%
  inner_join(get_sentiments("bing")) %>%
  mutate(movie = df$title[2]) %>%
  spread(sentiment, n, fill = 0)

sentiment3 <- word_seg(df$article[3]) %>%
  inner_join(get_sentiments("bing")) %>%
  mutate(movie = df$title[3])%>%
  spread(sentiment, n, fill = 0)

sentiment4 <- word_seg(df$article[4]) %>%
  inner_join(get_sentiments("bing")) %>%
  mutate(movie = df$title[4])%>%
  spread(sentiment, n, fill = 0)

sentiment5 <- word_seg(df$article[5]) %>%
  inner_join(get_sentiments("bing")) %>%
  mutate(movie = df$title[5])%>%
  spread(sentiment, n, fill = 0)

sentiment6 <- word_seg(df$article[6]) %>%
  inner_join(get_sentiments("bing")) %>%
  mutate(movie = df$title[6])%>%
  spread(sentiment, n, fill = 0)

sentiment7 <- word_seg(df$article[7]) %>%
  inner_join(get_sentiments("bing")) %>%
  mutate(movie = df$title[7])%>%
  spread(sentiment, n, fill = 0)

sentiment8 <- word_seg(df$article[8]) %>%
  inner_join(get_sentiments("bing")) %>%
  mutate(movie = df$title[8])%>%
  spread(sentiment, n, fill = 0)

sentiment9 <- word_seg(df$article[9]) %>%
  inner_join(get_sentiments("bing")) %>%
  mutate(movie = df$title[9])%>%
  spread(sentiment, n, fill = 0)

sentiment <- rbind.data.frame(sentiment1,sentiment2,sentiment3,sentiment4,sentiment5,
                              sentiment6,sentiment7,sentiment8,sentiment9)

sentiment <- sentiment %>% 
  mutate(direction = positive - negative) %>%
  group_by(movie) %>%
  summarise(direction = sum(direction)) %>%
  inner_join(df,by = c("movie" = "title"))

knitr::kable(sentiment[,1:3])
```

As the review indicates, almost all the reviews turns to the negative side. Especially three of them are obvious negative while the other six are around the zero. So how do the sentiment analysis performs? I introduce the ratings comes from IMDB to help evaluate by web scraping of the IMDB page for Star Wars.

## Information from IMDB

### Rating for each movie

Scraping from this url requires writing the regular expressions to get the information needed. And using the publishing year to match the movies is more convenient than matching with the name of the movies since the publishing year for each movie is unique. And the table below shows the Ratings and the directions. 

```{r,echo = FALSE, warnings = FALSE, message = FALSE}
IMDB_url <- "https://www.imdb.com/list/ls025989264/"

IMDB <-  IMDB_url %>%
  read_html() %>%
  html_nodes(".lister-item-content") %>%
  html_text()

IMDB <-  str_replace_all(IMDB,"\n","")
IMDB <- str_replace_all(IMDB,"  ","")

Year <- str_extract_all(IMDB,"[0-9]{4}") %>%
  as.character()
Rate <- str_extract_all(IMDB,"[1-9].[0-9]{2}R") %>%
  as.character()
Rate[6] <- "8.0R"
Rate[7] <- "7.0R"
for(i in 1:11){
  Rate[i] <- str_replace_all(Rate[i],"R","")
}


Rating = cbind.data.frame(Year, Rate,stringsAsFactors = FALSE)

sentiment$year <- sentiment$web_url %>%
  str_extract_all("[0-9]{4}") %>%
  as.character()

Rating <- sentiment %>% 
  left_join(Rating, by = c("year" = "Year")) %>%
  select("movie","year","Rate","direction")

knitr::kable(Rating)

```

As the table shows, the three movies: Return of the Jed(1983), Episode IV A New Hope(1977), and Star Wars: Episode VII - The Force Awakens(2015), are highly rated. All of the three movies get ratings over 8.0. The reviews must be kind of observative and critic, so that all the directions been caculated do not reveal strong positive feelings.

Besides, we can have a quick look at all the Ratings of Star Wars movies via the line plot:

```{r,echo = FALSE, warnings = FALSE, message = FALSE,fig.width=5,fig.height=3,fig.align='center'}

Rating$Rate <- as.numeric(Rating$Rate)

Rating_plot <- Rating %>%
  ggplot(mapping = aes(x = year, y = Rate)) +
  geom_line(aes(group = 1)) +
  geom_point() +
  xlab("Year") + ylab("Rating") +  
  ggtitle("The Star Wars Ratings from IMDB") +
  theme(plot.title = element_text(hjust = 0.5))
  
Rating_plot

```

The rating plot shows that the first two movies publishing around the 1980s are highly rated, but the following three movies are not that recommended. And the movies after 2015 have decreasing ratings as well. Only the four movies: Return of the Jed(1983), Episode IV A New Hope(1977), Star Wars: Episode VII - The Force Awakens(2015), and Rogue One: A Star Wars Story (2016) have relative high ratings.

### Votes ang Gross from IMDB page

Here is a sample of the tidy description of Star Wars movies from IMDB:


[1] "1.Star Wars: Episode V - The Empire Strikes Back(1980)PG | 124 min | Action Adventure Fantasy8.70Rate1Rate2Rate3Rate4Rate5Rate6Rate7Rate8Rate9Rate10Rate0Error: please try again.82MetascoreAfter the Rebels are brutally overpowered by the Empire on the ice planet Hoth Luke Skywalker begins Jedi training with Yoda while his friends are pursued by Darth Vader.Director:Irvin Kershner | Stars:Mark Hamill Harrison Ford Carrie Fisher Billy Dee WilliamsVotes:1045110|Gross:$290.48M"


The description gives extra information of the number of votes and the box-office value. These information also help to understand the popularity for the whole series.

```{r,echo = FALSE, warnings = FALSE, message = FALSE}
IMDB <- str_replace_all(IMDB,",","")
Votes <- str_extract_all(IMDB,"Votes:[0-9]{2,}")
Votes <- str_replace_all(Votes,"Votes:","")

Box <- str_extract_all(IMDB,"Gross:\\$[0-9]{1,}\\.[0-9]{1,}")
Box <- str_replace_all(Box,"Gross:\\$","")

IMDB_df <- cbind.data.frame(Year,Rate,Box,Votes,stringsAsFactors = FALSE)
info$year <- str_extract_all(info$date,"\\([0-9]{4}") %>% as.character()
info$year <- str_replace_all(info$year,"\\(","")

IMDB_df <- IMDB_df %>%
  inner_join(info,by = c("Year"="year")) %>%
  select(name,Year,Box,Rate,Votes)

knitr::kable(IMDB_df)
```

SO is there any relation among the Rate, Votes and Box? Here are several plot help visualize the relationships.

```{r,echo = FALSE, warnings = FALSE, message = FALSE,fig.width=5,fig.height=3,fig.align='center'}
IMDB_df$Box <-  as.numeric(IMDB_df$Box)
IMDB_df$Votes <- as.numeric(IMDB_df$Votes)
IMDB_df$Rate <- as.character(IMDB_df$Rate)

Box_plot <- IMDB_df %>%
  ggplot(mapping = aes(x = Year, y = Box)) +
  geom_line(aes(group = 1)) +
  geom_point() +
  xlab("Year") + ylab("Box-office Value") +  
  ggtitle("The Star Wars Box-office Value") +
  theme(plot.title = element_text(hjust = 0.5))

Box_plot <- Box_plot + theme_excel() + scale_fill_excel()

Box_plot

```

```{r,echo = FALSE, warnings = FALSE, message = FALSE,fig.width=5,fig.height=3,fig.align='center'}
Votes_plot <- IMDB_df %>%
  ggplot(mapping = aes(x = Year, y = Votes)) +
  geom_line(aes(group = 1)) +
  geom_point() +
  xlab("Year") + ylab("number of Votes") +  
  ggtitle("The Star Wars Number of Votes") +
  theme(plot.title = element_text(hjust = 0.5))
Votes_plot <- Votes_plot + theme_excel() + scale_fill_excel()

Votes_plot
```


The Box-office value reached the peak at 2015, when published the movie "Episode VIIThe Force Awakens". It seems that the box office of the movie after the 21st century are generally higher, which can be the result of economic development -- more people can afford the movies. But surprisingly the Box-office of "Solo: A Star Wars Story (2018)" is also low and true, with only 213mllion dollars.

However, the number of votes keeps decreasing. Only the first two movies published at 1990s get the votes over 1,000,000, which is quite surprising. People may not curious about this kind of fiction movies after seeing the first several of them.

Futher, we can try to find out the relationship between Box-office value and the number of votes. Is the movie with higher number of votes, which means higher attention, get higher box-office value?

```{r,fig.align='center',echo = FALSE, warnings = FALSE, message = FALSE,fig.width=5,fig.height=3}
ggplot(data = IMDB_df, aes(x = Box, y = Votes)) +
  geom_smooth(method = "lm", se=FALSE, color="red", formula = y ~ x) +
  ggtitle("Regress Votes ON Box") +
  geom_point(color = "blue") +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme_excel() + scale_fill_excel()

```

The regression line above shows little relationship between Box and Votes.  

The same question happens between Rates and the number of votes.

```{r,fig.align='center',echo = FALSE, warnings = FALSE, message = FALSE, fig.width=5,fig.height=3}
lm_RV <- lm(Rate~Votes,IMDB_df)
RV_coef <- lm_RV$coefficients

ggplot(data = IMDB_df, aes(x = Votes, y = Rate)) +
  geom_abline(intercept = RV_coef[1],slope = RV_coef[2],linetype="dashed", size=1.5) +
  ggtitle("Regress Rate on Votes") +
  geom_point(color = "blue") +
  theme(plot.title = element_text(hjust = 0.5))+ 
  theme_excel() + scale_fill_excel()

```

This plot shows that generally more number of votes (more attention paying to the movie) lead to higher ratings on the movie.

## conclusion
From the analysis above, the most popular movies of the whole series are: (1)Return of the Jed(1983),(2) Episode IV A New Hope(1977), (3)Star Wars: Episode VII - The Force Awakens(2015). The first two movies are the most famous two since theses space-opera fiction movies are rare at 1990s. The following movies extend the story with same background, but having less influence than the first two movies. 






